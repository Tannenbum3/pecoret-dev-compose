<script>
export default {
    name: 'ProjectVulnerabilityAutocompleteField',
    props: ['modelValue'],
    emits: ['update:modelValue', 'update:severity', 'change'],
    mounted() {
        if (this.modelValue && this.modelValue.pk) {
            let url = '/projects/' + this.projectId + '/vulnerabilities/' + this.modelValue.pk + '/';
            this.$api.get(url).then((response) => {
                this.choices = [response.data];
            });
        }
        this.loadData();
    },
    methods: {
        change() {
            this.$emit('update:severity', this.vulnerability.severity);
            this.$emit('update:modelValue', this.vulnerability.vulnerability_id);
            this.$emit('change', this.vulnerability);
        },
        onFocus() {
            if (this.choices) {
                return;
            }
            this.loadData();
        },
        loadData(search) {
            let url = '/projects/' + this.projectId + '/vulnerabilities/search/';
            let config = {};
            if (search) {
                config = {
                    params: { search: search.value }
                };
            }

            this.$api.get(url, config).then((response) => {
                this.choices = response.data;
            });
        }
    },
    data() {
        return {
            vulnerability: this.modelValue,
            projectId: this.$route.params.projectId,
            choices: []
        };
    }
};
</script>

<template>
    <label for="vulnerability">Vulnerability</label>
    <Dropdown v-model="vulnerability" :options="choices" optionLabel="name" @focus="onFocus" @change="change" @filter="loadData" filter id="vulnerability"> > </Dropdown>
</template>