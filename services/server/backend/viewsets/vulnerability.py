from django.conf import settings
from rest_framework import status
from rest_framework.decorators import action
from rest_framework.filters import SearchFilter
from rest_framework.response import Response

from backend import models
from backend.serializers.vulnerability import (
    VulnerabilityTemplateSerializer,
    ProjectVulnerabilitySerializer,
    VulnerabilityTemplateTranslationSerializer,
    VulnerabilityTemplateTranslationPatchSerializer
)
from pecoret.core import permissions
from pecoret.core.viewsets import PeCoReTModelViewSet


class VulnerabilityTemplateViewSet(PeCoReTModelViewSet):
    queryset = models.VulnerabilityTemplate.objects.order_by("vulnerability_id")
    search_fields = ["name", "vulnerability_id"]
    filterset_class = None
    api_scope = "scope_misc"
    serializer_class = VulnerabilityTemplateSerializer
    permission_classes = [
        permissions.GroupPermission(
            read_write_groups=[
                permissions.Groups.GROUP_PENTESTER
            ],
            read_only_groups=[
                permissions.Groups.ADVISORY_MANAGEMENT,
                permissions.Groups.GROUP_MANAGEMENT
            ],
        )
    ]

    @action(methods=['post'], detail=True, url_path='translations',
            serializer_class=VulnerabilityTemplateTranslationSerializer)
    def translation_create(self, request, *args, **kwargs):
        template = self.get_object()
        serializer = VulnerabilityTemplateTranslationSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        serializer.save(template=template)
        return Response(serializer.data, status=status.HTTP_201_CREATED)

    @action(methods=['get', 'patch', 'delete'], detail=True, url_path='translations/(?P<language>[^/.]+)',
            serializer_class=VulnerabilityTemplateTranslationSerializer)
    def translation_get(self, request, language, *args, **kwargs):
        template = self.get_object()
        valid_languages = [x[0] for x in settings.LANGUAGES]
        if language not in valid_languages:
            return Response(status=status.HTTP_404_NOT_FOUND)
        translation = models.VulnerabilityTemplateTranslation.objects.for_template(template).for_language(language)
        try:
            obj = translation.get()
        except models.VulnerabilityTemplateTranslation.DoesNotExist:
            return Response(status=status.HTTP_404_NOT_FOUND)
        if request.method.lower() == 'patch':
            serializer = VulnerabilityTemplateTranslationPatchSerializer(obj, data=request.data)
            serializer.is_valid(raise_exception=True)
            serializer.save()
            return Response(serializer.data, status=status.HTTP_200_OK)
        elif request.method.lower() == 'delete':
            obj.delete()
            return Response({}, status=status.HTTP_204_NO_CONTENT)
        serializer = VulnerabilityTemplateTranslationSerializer(obj)
        return Response(serializer.data, status=status.HTTP_200_OK)


class VulnerabilityTemplateTranslationViewSet(PeCoReTModelViewSet):
    queryset = models.VulnerabilityTemplateTranslation.objects.order_by('name')
    api_scope = 'scope_misc'
    serializer_class = VulnerabilityTemplateTranslationSerializer
    permission_classes = [
        permissions.GroupPermission(
            read_write_groups=[
                permissions.Groups.GROUP_PENTESTER
            ],
            read_only_groups=[
                permissions.Groups.ADVISORY_MANAGEMENT,
                permissions.Groups.GROUP_MANAGEMENT
            ]
        )
    ]


class ProjectVulnerabilityViewSet(PeCoReTModelViewSet):
    queryset = models.ProjectVulnerability.objects.none()
    search_fields = ["vulnerability_id", "name"]
    filterset_class = None
    serializer_class = ProjectVulnerabilitySerializer
    permission_classes = [permissions.PRESET_PENTESTER_OR_READONLY]

    def get_queryset(self):
        return models.ProjectVulnerability.objects.for_project(self.request.project)

    def perform_create(self, serializer):
        serializer.save(project=self.request.project)

    @action(detail=False, methods=["get"])
    def search(self, request, project, pk=None):
        search_filter = SearchFilter()
        project_vulnerabilities = search_filter.filter_queryset(
            request,
            self.get_queryset(),
            self,
        )
        available_templates = search_filter.filter_queryset(
            request,
            models.VulnerabilityTemplate.objects.exclude(
                vulnerability_id__in=project_vulnerabilities.values_list(
                    "vulnerability_id", flat=True
                )
            ),
            self,
        )
        project_vuln_serializer = ProjectVulnerabilitySerializer(project_vulnerabilities, many=True)
        template_vuln_serializer = ProjectVulnerabilitySerializer(available_templates, many=True)
        full_data = project_vuln_serializer.data + template_vuln_serializer.data
        return Response(data=full_data)
